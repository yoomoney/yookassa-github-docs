[http](/demo/010%20интеграция%20для%20самописных%20сайтов.md), [cms](/demo/011%20интеграция%20для%20CMS%20и%20SaaS.md), [email](/010%20интеграция%20email.md), [тестирование](/demo/030%20тестирование.md), :mag:[решение ошибок](/demo/031%20решение%20ошибок.md), [демо](/demo/032%20демо%20стенд.md)

:mag: Решение ошибок при тестировании
===============================

> Если при [тестировании оплаты](/demo/030%20тестирование.md) вы получили ошибку, используйте ниже следующие рекомендации.

### Ошибки HTTPS

#### Сайт должен быть доступен по HTTPS
Данный пункт необходим только для тех магазинов, которые интегрируются по HTTP или CMS схеме интеграции. Для Email это пункт можно пропустить.
   * Обратитесь к своему сайту по https протоколу, ссылка будет выглядеть так https://имясайта.ру. Если сайт не открывается, а открывается что-то другое или вообще не происходит загрузки страницы, решите этот вопрос с техподдержкой вашего хостинга или системным администратором вашего сервера (скорее всего потребуется выделенный IP и SSL сертификат).
   * Если нужен бесплатный SSL-сертификат, обратитесь к своему персональному менеджеру по адресу merchants@yamoney.ru, указав в теме письма: "shopid=ваш-номер нужен бесплатный SSL" (обратите внимание, что для кириллических доменов бесплатные ssl-сертификаты, к сожалению, не выдаются и нужно будет приобрести его платно, т.е. тогда надо обратиться в вашему хостинг-провайдеру по вопросу покупки сертификата; цена в среднем 2 т.р. в год).

### Технология SNI

К сожалению, наша система не поддерживает режим SNI при работе по HTTPS. Ниже описаны методы проверки и варианты решения.

#### Проверка
* Перейдите на сайт https://www.ssllabs.com/ssltest/index.html и введите имя своего сайта (например, `nameyousite.tld`) и нажмите кнопку "Submit".
* Через пару минут после этого вы увидите на экране результаты диагностики.
  * Если видите надпись `This site works only in browsers with SNI support.`, значит доступ к вашему сайту по HTTPS настроен с применением технологии SNI, которую мы не поддерживаем (см. ниже что делать: сертификаты cloudflare или Let's Encrypt)
  ![пример результата диагностики HTTPS доступа к сайту](/demo/ssllabs-https-check-sample.png "пример результата диагностики HTTPS доступа к сайту")


#### Если вы используете **HTTPS от cloudflare**
   * Доступ по HTTPS от Cloudflare работает по технологии SNI. В настоящий момент наша платежная система не поддерживает этот режим (поддержка ожидается примерно в третьем квартале 2017 года). Если ваш сайт работает через Cloudflare, вам надо обратиться в техподдержку Cloudflare с просьбой перевода на HTTPS без режима SNI.

#### Если вы используете **SSL сертификат от Let's Encrypt** 
   * Сертификаты от Let's Encrypt чаще всего используют хостинг провайдеры по технологии SNI (когда на одном IP находится несколько доменов). В настоящий момент наша платежная система не поддерживает этот режим (поддержка ожидается примерно в третьем квартале 2017 года). Если ваш сайт работает с использованием сертификата от Let's Encrypt, вам надо обратиться в техподержку своего хостинга с просьбой перевода на HTTPS без режима SNI, для этого обратитесь в техподдержку вашего хостинга, чтобы они подключили услугу выделенного IP (обычно услуга платная). Это должно решить вопрос прохождения платежей.

#### Диагностика показала, что сайт не использует SNI

* Если ваш сайт доступен по HTTPS и при диагностике надписи о SNI нет, тогда смотрите другие разделы данной статьи.
  
---
   
### Ошибки редиректов 302

1. Не должно быть редиректов www -> основное-имя-сайта (или обратно)
   * Проверьте, чтобы при обращении к сайту не происходило никаких редиректов с https на http, с www на основное имя, или наоборот. Самое главное, чтобы при обращении к https://имя-сайта/скрипт-чек-или-авизо не происходило никаких редиректов.
   * Что делать, если редирект есть, но его нельзя отключить? Допустим настройка магазина checkURL https://site.ru/checkurl.php и при обращении к скрипту происходит редирект на https://www.site.ru/checkurl.php (т.е. на www-синоним). [Смените настройку в ЛК](https://money.yandex.ru/my/tunes), указав новый путь к скриптам: было https://site.ru/checkurl.php, станет https://www.site.ru/checkurl.php (для авизо скрипта тоже самое).

### Ошибки shopPassword

1. Неверный shopPassword
   * Если у вас самописный сайт, проверьте, чтобы [при подсчете MD5](/demo/010%20интеграция%20для%20самописных%20сайтов.md#Шаг-21-Проверка-md5-суммы-при-ответах-на-запросы-checkorder-и-paymentaviso-документация) суммы, был указан корректный [shoppassword](/demo/shopPassword-теханкета-ЛК-Кассы.png).
   * Если у вас готовый платежный модуль (в CMS и т.п.), проверьте, что в настройках платежного модуля указан верный shoppassword.

### Ошибки scid, shopid, shopArticleId

1. В демо тестировании используйте scid для демо
   * При платеже в демо среде в вашей форме должен быть указан именно демо scid, а не боевой (вы получаете его в письме, где явным образом указано, что это демо scid).
   * Если у вас готовый платежный модуль (в CMS и т.п.), проверьте, что в настройках платежного модуля указан в демо-настройках корректный демо-scid.
   2. Если у вас два и более магазинов (shopid), не нужно в значении shopid использовать оба. В качестве значения shopid может только одно значение и не более, например, `shopid=100500`. Тоже самое касается scid и shopArticleId. Из формы могут быть переданы только по одному указанному параметру и их значение. Нельзя передать `shopid=100500` и `shopid=100777` (это касается и других параметров). Общее правило: один уникальный параметр и одно уникальное значение данного параметра.
   
### Ошибки checkURL и avisoURL

Эти рекомендации касаются в первую очередь [самописных сайтов](/demo/010%20интеграция%20для%20самописных%20сайтов.md) (если у вас сайт на CMS или на email-схеме, то эти рекомендации вам не нужны).

1. По ссылке checkURL должен отвечать скрипт ответом `checkOrderResponse`, а по ссылке avisoURL скрипт должен отвечать `paymentAvisoResponse`. Одна из распространенных ошибок, когда их меняют местами и на чек мы получаем ответ `paymentAvisoResponse`, а на авизо `checkOrderResponse`.
2. Пример правильного ответа checkURL-скрипта: `<?xml version="1.0" encoding="UTF-8"?><checkOrderResponse performedDatetime="2011-05-04T20:38:01.000+04:00" code="0" invoiceId="2000000907465" shopId="100500"/>`
3. Пример правильного ответа avisoURL-скрипта: `<?xml version="1.0" encoding="UTF-8"?><paymentAvisoResponse performedDatetime="2011-05-04T20:38:11.000+04:00" code="0" invoiceId="2000000907465" shopId="100500"/>`
4. Корректность формата важна
   * Если забудете кавычки, например, `code=0`, то это будет НЕ правильный ответ. Правильный: `code="0"`
   * Правильный формат даты `YYYY-MM-DDThh:mm:ss.fZZZZZ`
     * Так НЕ правильно: `performedDatetime="2017-04-10T18:19:42+04:00"`
     * Так правильно: `performedDatetime="2017-04-10T18:19:42.000+04:00"`
5. Все параметры регистрозависимы.
   * Например
     * НЕ правильно: `PerformedDatetime`
     * Правильно: `performedDatetime`.
     * См. пример правильного регистра выше в п.2 и п.3. Если регистр указан не верно, то наша система не будет считать ответ корректным и платеж не пройдет.

### Ошибка суммы платежа

Обратите внимание, что в стоимости товара должно быть два знака после точки (в нашем синтаксисе протокола мы используем разделитель точка `sum="100.00"`). Если вы передаете один знак после запятой `sum="100.0"` или вообще без знака `sum="100"`, это в дальнейшем может привести к ошибке платежа. Поэтому передавайте два знака `sum="100.00"` и проверяйте (если у вас самописные скрипты взаимодействия с Яндекс.Кассой, а не CMS модуль) при подсчете MD5 значение суммы платежа с двумя знаками после разделителя. Общее правило: передавайте с двумя знаками после разделителя и проверяйте MD5 с двумя знаками на запросах checkOrder и paymentAviso.

### 502 Bad Gateway

1. Суммарный объем данных, передаваемых из формы, не должен превышать 4096 символов. Если он превышен, то вы получите ошибку HTTP 502 Bad Gateway.

### Не работает оплата через Киви

Информация только для реальных платежей. В демо режиме данный метод не поддерживается.

После подключения метода Киви требуется время для того, чтобы метод заработал. При его подключении магазину, происходит включение метода на нашей стороне и одновременно запускается процесс согласования с сервисом Qiwi (на это уходит в среднем 1-2 недели). Поэтому метод может начать работу в пределах от одной до двух недель после его подключения. Если с момента подключения магазина к реальным платежам и с момента подключения метода Киви не прошел этот срок, пожалуйста, подождите.

Если с момента подключения метода прошло 2 недели, но метод не работает, напишите на адрес poisk@yamoney.ru, в теме письма напишите "не работает метод Qiwi, shopid=ваш-номер-shopid", в теле письма: дату, время и сумму платежа.

---

## Ничего не помогло

Если перечисленные выше рекомендации не относятся к вам и по этим пунктам у вас все в порядке, либо вам они оказались не понятны, то:
- пришлите ссылку на страницу вашего сайта, на которой мы бы могли выполнить тестовую оплату самостоятельно;
- пришлите ссылку на страницу ошибки, которую вы получили при выполнении платежа, дату и время получения этой ошибки;
- по возможности пришлите нам данные, которые передаются из вашей платежной формы, см. инструкцию https://clck.ru/9yYy5
