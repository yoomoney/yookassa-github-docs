

[![яндекс касса](/i/yakassalogo.png "Яндекс Касса")](https://kassa.yandex.ru) / [помощь](https://yandex.ru/support/checkout/) / [api-докуметация](https://kassa.yandex.ru/docs/checkout-api/#api-yandex-kassy), [api-гайды](https://kassa.yandex.ru/docs/guides/#bystryj-start), [YandexCheckout.js](https://kassa.yandex.ru/docs/checkout-js/#yandexcheckout-js)

Return_url. Рекомендации по реализации
======================================

### Один платеж, один `return_url`

> При [создании платежа](https://kassa.yandex.ru/docs/checkout-api/#sozdanie-platezha) в параметре `return_url` вы передаете ссылку, которая будет работать на любом этапе платежа как ссылка кнопки "вернуться в магазин". Определение статуса платежа в момент перехода на вашу страницу `return_url` необходимо выполнить через [запрос о статусе платежа](https://kassa.yandex.ru/docs/checkout-api/#informaciq-o-platezhe).

#### За и против

"Один `return_url`?", - вполне адекватный вопрос программиста, привыкшего к реализации, когда URL-ы страницы для успеха, ошибки или иного статуса, заранее известны. Почему в нашем API мы выбрали вариант, когда страница одна и почему мы считаем такой вариант наулучшим.

##### Пример оплаты методом Сбербанк-онлайн

Плательщик получил смс с номера 900, подтвердил, но в сбербанке сбой в компоненте оплаты. Или у мобильного оператора очередь доставки смс. Сам пользователь не нажал кнопку отправки смс или телефон по каким-то причинам не выполнил отправку смс. Факт: платеж не оплачен. На какую страницу должна вести ссылка "Вернуться в магазин" в этот момент времени? Успех? Нет. Ошибки? Нет. Промежуточный статус? Возможно. А если в момент перехода по ссылке "Вернуться в магазин" статус изменился, смс дошла, деньги списались, а вы плательщику покажете "Что-то пошло не так". В общем, довольно сложно сделать 100%-ное попадание.

Решение1: После перехода плательщика на страницу `return_url` сделать запрос, показав иформацию в зависимости от статуса.

| Значение status | Что сообщить покупателю |
| --------------- | ----------------------- |
| `panding`       | Заказ еще не оплачен. Если вы оплатили заказ, обратите внимание, что Сбербанк еще не передал информацию об успехе оплаты. Проверка статуса будет выполнена автоматически через 1 минуту. |
| `canceled`      | Заказ не оплачен. В процессе оплаты произошла ошибка в платежной системе. Средства были возвращены на ваш счет. Если информация об этом не отобразилась в ЛК.Сбербанка или нет смс о возврате средств, пожалуйста, подождите. Возврат средств может занять до трех дней. (Возможно еще какой-либо текст). |
| `succeeded`     | Поздравляем! Заказ оплачен. Средства успешно пришли в наш магазин. Вы можете забрать ваш заказ по адресу: город, улица, офис, схема проезда. Обратите внимание, что вы можете заказать курьерскую доставку (кнопка для заказа), т.к. сумма вашего заказа больше 1000 руб. доставка бесплатная. | 
| `waiting_for_capture` | Мы видим, что вы оплатили заказ. Приносим свои извинения, но с момента начала заказа прошло 2 часа и выяснилось, что товара нет на складе. Если вы готовы подождать, менеджер свяжется с вами и товар будет доставлен через два дня. Либо нажмите здесь и заказ будет анулирован, средства вернутся на ваш счет. | 

Вариант2
Плательщик не получил никакой смс или не понял что ему делать и поэтому просто вернулся обратно на сайт нажав на кнопку "Вернуться в магазин". Куда он должен попасть?

Решение1: После перехода плательщика на страницу `return_url` сделать запрос и показать актуальный статус.

Вариант3
Плательщик все сделал верно, все смс пришли, сбербанк и все остальные списали деньги с пользователя. Казалось бы, кнопка "вернуться в магазин" на страницу для успеха самое верное решение. Но оказалось, что пока плательщик платил, выяснилось, что товара нет на складе, не тот цвет или не надлежащего качества. Плательщик оплатил и перешел на вашу страницу Успеха?



### Чего не будет

Сценарий, к которому привыкли пользователи нашего старого API и которого теперь не будет. В старом API было три ссылки:
* shopDefaultUrl - ссылка "вернуться в магазин", на странице платежа до момента осуществления оплаты;
* shopSuccessURL - ссылка на странице успеха платежа, после успешной оплаты;
* shopFailURL - ссылка на странице, которая отображается после нажатия кнопки "оплатить" и если оплата была не успешной (не достаточно средств, не пройден 3DS и т.д.)

Теперь только одна ссылка, значение которой передается в `return_url`.
