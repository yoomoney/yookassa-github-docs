[![яндекс касса](/i/yakassalogo.png "Яндекс Касса")](https://kassa.yandex.ru) / [помощь](https://yandex.ru/support/checkout/) / [api-докуметация](https://kassa.yandex.ru/docs/checkout-api/#api-yandex-kassy), [api-гайды](https://kassa.yandex.ru/docs/guides/#bystryj-start), [YandexCheckout.js](https://kassa.yandex.ru/docs/checkout-js/#yandexcheckout-js), [PHP-SDK](https://github.com/yandex-money/yandex-checkout-sdk-php), [mSDK](https://kassa.yandex.ru/docs/client-sdks/#mobil-nye-sdk), [en](https://checkout.yandex.com/docs/checkout-api/#using-the-api)

URL для уведомлений
===================

> URL для уведомлений - это ваш cкрипт, ссылку на который вы прописываете [в настройках магазина](#%D0%9B%D0%9A) в нашем личном кабинете (изменения вступают в силу мгновенно). На этот URL платежная система Яндекс.Касса автоматически отправляет уведомления [waiting_for_capture](#waiting_for_capture) или [succeded](#succeded) во время того, когда ваш плательщик производит оплату. В ответ наша система должна получить ответ HTTP 200. Подробности ниже.

## Обзор уведомлений о статусе платежа

### Платеж прошел, колбека нет

**q**: Мы сформировали платеж, получили `confirmation_url`, перешли к оплате и провели её, оплата успешная, но колбека на url для уведомлений нет.

**a**: Проверьте следующие моменты:
1. Урл для уведомлений действительно доступен по HTTPS? По HTTP наши уведомления не доставляются.
2. В запросе на [создание платежа](https://kassa.yandex.ru/docs/checkout-api/#sozdanie-platezha) было передано `"capture": "true"`? Если да, то в этом случае придет только одно уведомление succeded.

> Уведомление на ваш URL для уведомлений доставляется при переходе платежа в статус `"waiting_for_capture"` или `"succeded"`.

### waiting_for_capture

Статус `"waiting_for_capture"` значит, что плательщик выполнил успешную оплату и теперь платеж ожидает вашего capture ([подтверждения платежа](https://kassa.yandex.ru/docs/checkout-api/#podtwerzhdenie-platezha), в том числе частичного) или cancel ([отмены](https://kassa.yandex.ru/docs/checkout-api/#otmena-platezha)).

Внимание! В статусе `"waiting_for_capture"`, если это оплата банковской картой, платеж будет находиться 7 дней, а для остальных методов платежа 2 часа. В этом интервале вам обязательно нужно выполнить capture или cancel. Если вы не выполните capture, то заказ будет отменен (cancel) автоматически и деньги вернутся плательщику.

**Пример** (пример нашего колбека на ваш URL для уведомлений; такие данные придут на него от нас, POST запросом):
```
{"type":"notification","event":"payment.waiting_for_capture","object":{"id":"2185355e-000f-5081-a000-0000000",
"status":"waiting_for_capture","paid":true,"amount":{"value":"10.00","currency":"RUB"},"created_at":"2017-09-27T12:07:58.702Z",
"expires_at":"2017-11-03T12:08:23.080Z","metadata":{},"payment_method":{"type":"bank_card","id":"2185355e-000f-5081-a000-0000000",
"saved":false,"card":{"last4":"1026","expiry_month":"12","expiry_year":"2025","card_type":"Unknown"},"title":"Bank card *1026"},
"recipient":{"account_id":"000005","gateway_id":"0000015"}}}
```

### succeded

Статус `"succeded"` значит, что плательщик выполнил успешную оплату и деньги будут списаны в пользу вашего магазина.

**Пример** (пример нашего колбека на ваш URL для уведомлений; такие данные придут на него от нас, POST запросом)::
```
{"type":"notification","event":"payment.succeeded","object":{"id":"2203aa1d-000f-5000-8000-17102541fd31",
"status":"succeeded","paid":true,"amount":{"value":"1.00","currency":"RUB"},"captured_at":"2018-01-31T10:12:06.249Z",
"created_at":"2018-01-31T10:11:41.499Z","description":"Оплата тестового заказа №100500 для магазина Вереница","metadata":{"zakaz":"100500","param3":"value3","param2":"value2"},
"payment_method":{"type":"bank_card","id":"2203aa1d-000f-5000-8000-17102541fd31","saved":false,
"card":{"last4":"1026","expiry_month":"12","expiry_year":"2025","card_type":"Unknown"},"title":"Bank card *1026"},
"recipient":{"account_id":"500105","gateway_id":"1500105"},"refunded_amount":{"value":"0.00","currency":"RUB"},"test":true}}
```
## ЛК

В личном кабинете Яндекс.Кассы вы можете прописать необходимый URL вашего скрипта для наших уведомлений.

![url для уведомлений, в ЛК.Кассы](/checkout-api/api.notification.url.lk.png "url для уведомлений, в ЛК.Кассы")

## Нюансы

### PHP

**q**: Мы сделали все так, как написано выше, но наш PHP-скрипт не получает никаких данных (тело запроса пустое).

**a**: Скорее всего вы выполняете перехват методом `$_POST` и поэтому получаете пустой результат. Попробуйте через:  
`file_put_contents ("путь_до_лога", print_r(json_decode(file_get_contents("php://input")), true));`.
<!--
### Perl, Content-Length

**q**: Делаем `read( STDIN, $buffer, $ENV{'CONTENT_LENGTH'} );`, но не получается.

**q**: В настоящий момент мы не передаем `Content-Length`. Есть постановка на модификацию протокола, но до этого момента, пожлалуйста, учитывайте, что в Header мы не передаем `Content-Length`.
-->
### IP

**q**: С каких IP будут приходить уведомления?

**a**: Список наших IP, с которых вы будете получать уведомления:
```
185.71.77.2
185.71.77.3
185.71.77.4
185.71.77.5
185.71.76.2
185.71.76.3
185.71.76.4
```
### Тайминг

**q**: Если мой URL для уведомлений был не доступен (перезагружался сервер, временная сетевая недоступность и т.д.), сколько будет всего дополнительных уведомлений и в какой интервал?

**a**: Всего будет 7 уведомлений. С момента первого и до момента последнего уведомления пройдет 24 часа. Текущие интервалы уведомлений в секундах: `10, 42, 84, 168, 672, 5376, 86016` секунд.

### Изменение URL

**q**: Если был `платеж-1`, при этом в настройках был `урл-для-уведомлений-1`. Уведомление не было доставлено. Мы изменили настройки на `урл-для-уведомлений-2`. Куда будут доставлены уведомления по `платежу-1`?

**a**: Уведомления доставляются на тот урл, который был действительным на момент оплаты. Это значит, что если был `платеж-1` и настройка `урл-для-уведомлений-1`, то после изменения настройки на `урл-для-уведомлений-2` уведомления будут доставляться на `урл-для-уведомлений-1`.

### Уведомления после capture

**q**: Мы не стали дожидаться уведомления, потому что через [запрос статуса заказа](https://kassa.yandex.ru/docs/checkout-api/#informaciq-o-platezhe) выяснили, что статус уже `"waiting_for_capture"` и выполнили **capture**. Почему уведомления продолжают поступать?

**a**: Доставка уведомлений продолжается вне зависимости от изменения статуса `"waiting_for_capture"` на другие (`canceled` или `succeeded`) до момента, пока не будет получен в ответ HTTP код 200 или пока не будут выполнены [7 попыток доставки](#Тайминг).

### Временная замена урла для уведомлений для тестирования

https://webhook.site/

<!--
2all: если у мерч нет вебхука (он же урл для уведомлений), скажем, его еще надо сделать, а тестироваться уже хочется, можно использовать сервис https://webhook.site/

1. Заходим по урлу,
2. Нажимаем NEW URL, заполняем дефолтом (там в подсказках предлагается). Получаем уникальный урл.
3. Прописываем урл в тестовом магазине.
4. Получаем уведомления, открыв урл эти уведомления видны.

Например, система дала урл https://webhook.site/78164af0-367e-41d1-b7dc-623381bdc478
При платеже наш колбек виден
https://webhook.site/#/78164af0-367e-41d1-b7dc-623381bdc478/9ec54a73-0673-4872-8a06-a7844c7c887c/0
-->
